import fs from 'fs';
import _ from 'lodash';
import path from 'path';
import yargs from 'yargs';
import _dotenv from 'dotenv';

export const dotenv = _dotenv;

function readFile(target: string) {
    try {
        return fs.readFileSync(target);
    } catch (error) {
        return '';
    }
}

// 从 env 文件中加载环境变量
// 参考 https://cli.vuejs.org/zh/guide/mode-and-env.html
export function loadEnvVariables(from = process.cwd()) {
    const mode = yargs.argv.mode;

    // .env
    const baseEnv = _dotenv.parse(readFile(path.join(from, '.env')));

    // .env.local
    const localEnv = _dotenv.parse(readFile(path.join(from, '.env.local')));

    // .env.mode
    const modeEnv = _dotenv.parse(readFile(path.join(from, `.env.${mode}`)));

    const unionConfig = _.merge({}, baseEnv, localEnv, modeEnv);

    // 扩展 dotenv 解析模式，支持 functions.xxx=xxx 形式设置对象
    return Object.keys(unionConfig).reduce((prev, key) => {
        return _.set(prev, key, unionConfig[key]);
    }, {});
}
