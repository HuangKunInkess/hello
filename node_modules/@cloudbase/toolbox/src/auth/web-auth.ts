import { resolveCredential } from './common';
import { md5Encoding } from '../coding';
import { getDataFromWeb } from '../web';
import { getMacAddress, getOSInfo } from '../system';
import { Credential, WebAuthCredential } from '../types';

const CliAuthBaseUrl = 'https://console.cloud.tencent.com/tcb/auth';

// 打开云开发控制台，获取授权
export async function getAuthTokenFromWeb(
    options: {
        getAuthUrl?: (rawUrl: string) => string
    } = {}
): Promise<Credential> {
    const { getAuthUrl } = options;

    const mac = await getMacAddress();
    const os = getOSInfo();
    const macHash = md5Encoding(mac);

    const query: WebAuthCredential = await getDataFromWeb<
        WebAuthCredential & { [key: string]: string }
    >((port) => {
        // 授权链接
        let cliAuthUrl = `${CliAuthBaseUrl}?port=${port}&hash=${macHash}&mac=${mac}&os=${os}&from=cli`;

        if (getAuthUrl) {
            try {
                cliAuthUrl = getAuthUrl(
                    `${CliAuthBaseUrl}?port=${port}&hash=${macHash}&mac=${mac}&os=${os}&from=cli`
                );
            } catch (error) {
                // 忽略错误
            }
        }

        return cliAuthUrl;
    }, 'login');

    const credential: Credential = resolveCredential(query);

    return credential;
}
